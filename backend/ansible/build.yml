---
- name: Build code on target machine architecture
  vars:
    wheel_name: 'flightlog-{{ version }}-py3-none-any.whl'
  hosts: webservers

  tasks:
    - name: Create a directory if it does not exist
      ansible.builtin.file:
        path: /tmp/flightlog-docker
        state: directory

    - name: Upload python wheel
      ansible.builtin.copy:
        src: '../dist/{{ wheel_name }}'
        dest: '/tmp/flightlog-docker/{{ wheel_name }}'

    - name: Upload docker file
      ansible.builtin.copy:
        src: ../docker/Dockerfile
        dest: /tmp/flightlog-docker/Dockerfile

    - name: Docker login
      become: yes
      community.docker.docker_login:
        registry_url: https://ghcr.io/
        username: millarcalder
        password: !vault |
                  $ANSIBLE_VAULT;1.1;AES256
                  38393231643938336366353564323436356336393265646639613334383162363139656336373162
                  3236303866623139326561633462346661663366383539390a666662313933373035373238353636
                  37313132393661373462393136323062363630653766343536313438333731653264383036643937
                  3532323163373862630a313261656138343233313065356238363539633033396462363033363466
                  30636234306130393433393834333732633366313939633566623663366265393762653136633830
                  6266376333306132393033356365333365336237313437636561

    - name: Build docker image
      become: yes
      community.docker.docker_image:
        build:
          args:
            wheel_name: '{{ wheel_name }}'
          path: /tmp/flightlog-docker
        name: ghcr.io/millarcalder/flightlog
        tag: 'pi-{{ version }}'
        push: yes
        source: build
        debug: yes

    - name: Docker logout
      become: yes
      community.docker.docker_login:
        state: absent
